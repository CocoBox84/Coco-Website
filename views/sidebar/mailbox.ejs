<!DOCTYPE html>
<html>

<head>
  <title>Coco Sidebar page <%  %></title>
  <link rel="stylesheet" href="/sidebar/main.css">
  <link rel="stylesheet" href="/sidebar/mailbox.css">
</head>

<body>
  <div id="container">
    <header>
      <% if (isLoggedIn) { %>
      <h4>Welcome, <%= user.username %>!</h4>
      <% } else { %>
      <h4>Welcome, User!</h4>
      <% } %>
      <a href="/sidebar/help/screens/about/"><button>About Coco</button></a>
      <a href="/sidebar/help/screens/help/"><button>Help with Coco</button></a>
      <a href="/sidebar/help/screens/mailbox/"><button>Mailbox</button></a>
      <img id="sun" alt="" src="/Stickers/Sun.stikr">
      <p id="sun-text">The Coco Help Screens</p>
    </header>
    <div id="webpage">
      <main id="main" class="mailbox">
        <% if (isLoggedIn) { %>
        <h3>Welcome to your Mailbox!</h3>
        <h4>Send and receive messages.</h4>
        <img height="100px" src="/Stickers/Mailman.svg" alt="Mailman Coconut">
        <div id="post-office">
          <div id="inbox">
            <h3><img src="/Stickers/Mailbox.stikr" height="50px" alt="Mailbox"> Mailbox (Your messages):</h3>
            <div>
              Options: <br>
              <button onclick="refreshMessages()">Refresh</button>
              <button onclick="loadMessages()">Load More Messages</button>
              <button onclick="loadSentMessages()">Load More Sent Messages</button>
            </div>
            <ul id="messages"></ul>
            <button onclick="loadMessages()">Load More Messages</button>
            <button onclick="refreshMessages()">Refresh</button>
          </div>
          <div id="outbox">
            <h3>Send a message:</h3>
            <div id="message-station">
              <img src="/Stickers/Message Sender.stikr" height="70px" alt="Coco Sends a message">
              <form id="message-form">
                <br>
                Title: <br>
                <input type="text" id="message-title" placeholder="Enter message title...">
                <br>
                Write: <br>
                <textarea id="your-text" placeholder="Enter text here..." name="to"></textarea>
                <br>
                To:
                <input id="message-to" type="text" placeholder="Example: @Coco, or @Nino">
                <br>
                From: @<%= user.username %><br> As: <input type="text" name="from" id="Sender-Nickname" placeholder="Enter a nickname">
                <button onclick="sendMessage();">Send</button>
                <div id="server-response"></div>
              </form>
            </div>
            <h3><img src="/Stickers/Mail.stikr" height="30px" alt="Mail"> Sent messages:</h3>
            <ul id="sent-messages"></ul>
            <button onclick="loadSentMessages()">Load More Sent Messages</button>
          </div>
        </div>
        <% } else { %>
        <h2>Your not logged in.</h2>
        <p>Please login to use your mailbox.</p>
        <% } %>
      </main>
    </div>
    <footer>
      <h4>Footer:<br></h4>
      <div id="footer-content">
        <a href="/sidebar/help/screens/about/">About</a>
        <a href="/sidebar/help/screens/help/">Help</a>
        <a href="/sidebar/help/screens/mailbox/">Messages</a>
        <br>
        <h5>Help:</h5>
        <a href="/sidebar/help/screens/login/">Help with Login</a>,
        <a href="/sidebar/help/screens/signup/">Help with Creating an account</a>,
        and <a href="/sidebar/help/screens/editUser/">Help with changing user settings</a>
      </div>
    </footer>
  </div>

  <script>
    function escapeHTML(str) {
      const div = document.createElement("div");
      div.textContent = str; // browser escapes automatically
      return div.innerHTML;
    }

    // Utility: strip <a> tags but keep their text
    function stripLinks(str) {
      const div = document.createElement("div");
      div.innerHTML = str;
      div.querySelectorAll("a").forEach(a => {
        const text = a.textContent;
        a.replaceWith(text); // replace <a> with its text
        a.style.textDecoration = "underline";
      });
      return div.textContent; // return plain text
    }

    let messageIndex = 0;
    let messageSentIndex = 0;

    // Pass isSidebar=true when rendering inside the sidebar iframe
    function loadMessages(isSidebar = true) {
      const start = messageIndex;
      const count = 5;

      fetch('/api/user/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            start,
            count
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log("received response");
          const messagesBox = document.getElementById('messages');

          data.messages.forEach(message => {
            messageIndex++;
            if (!message) return;

            // Parse sender
            let senderObj;
            if (typeof message.sender === "string" && message.sender !== "System" && message.sender !== "Admin") {
              try {
                senderObj = JSON.parse(message.sender);
              } catch {
                senderObj = {
                  nickname: message.sender,
                  user: {
                    username: message.sender
                  }
                };
              }
            } else {
              senderObj = {
                nickname: message.sender,
                user: {
                  username: message.sender
                }
              };
            }

            // Sender display logic
            let senderDisplay;
            if (message.sender === "System" || message.sender === "Admin") {
              senderDisplay = `From ${senderObj.user.username}`;
            } else if (senderObj.nickname === senderObj.user.username) {
              senderDisplay = `
          <img src="/users/${senderObj.user.username}/pfp/" 
               alt="${senderObj.user.username}'s Profile Picture" 
               height="50px" width="70px" style="border:2px solid black; background-color: white !important;">
          <br>${senderObj.nickname}`;
            } else {
              senderDisplay = `
          <img src="/users/${senderObj.user.username}/pfp/" 
               alt="${senderObj.user.username}'s Profile Picture" 
               height="50px" width="70px" style="border:2px solid black; background-color: white !important;">
          <br>From @${senderObj.user.username} as "${senderObj.nickname}"`;
            }

            // Escape title always
            const safeTitle = escapeHTML(message.title);

            let safeContent;
            if (isSidebar) {
              // Sidebar rules
              if (message.sender === "System" || message.sender === "Admin") {
                safeContent = stripLinks(message.content); // strip <a>, keep text
              } else {
                safeContent = escapeHTML(message.content); // plain text only
              }
            } else {
              // Full page rules
              if (message.sender === "System" || message.sender === "Admin") {
                // allow links, but escape everything else
                const div = document.createElement("div");
                div.innerHTML = message.content;
                // escape non-link text
                div.childNodes.forEach(node => {
                  if (node.nodeType === Node.TEXT_NODE) {
                    node.textContent = escapeHTML(node.textContent);
                  }
                });
                safeContent = div.innerHTML;
              } else {
                safeContent = escapeHTML(message.content); // plain text only
              }
            }

            // Build message element
            const messageElement = document.createElement("li");
            messageElement.dataset.messageId = message.id;
            messageElement.className = message.isRead ? "read" : "unread";
            messageElement.innerHTML = `
        <h2>${safeTitle}</h2>
        <h3>${senderDisplay}:</h3>
        <p>${new Amp().Stickerify(safeContent)}</p>
        <div>
          ${(message.sender !== "System" && message.sender !== "Admin") ? `
            <button class="special-button" onclick="reportMessage(${message.id})">Report Message</button>
            ${(senderObj.user.username !== "<%= user.username %>") ? '<button class="special-button">Block user</button>' : ""}
          ` : ""}
          <button class="special-button" onclick="deleteMessage(${message.id})">Delete</button>
        </div>
      `;



            messagesBox.appendChild(messageElement);
          });
        })
        .catch(error => {
          console.error('Error loading messages:', error);
          showError();
        });
    }

    function loadSentMessages(isSidebar = true) {
      const start = messageSentIndex;
      const count = 5;

      fetch('/api/user/sent/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            start,
            count
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log("received response");
          const messagesBox = document.getElementById('sent-messages');

          data.messages.forEach(message => {
            messageSentIndex++;
            if (!message) return;

            // Parse sender
            let senderObj;
            if (typeof message.sender === "string" && message.sender !== "System" && message.sender !== "Admin") {
              try {
                senderObj = JSON.parse(message.sender);
              } catch {
                senderObj = {
                  nickname: message.sender,
                  user: {
                    username: message.sender
                  }
                };
              }
            } else {
              senderObj = {
                nickname: message.sender,
                user: {
                  username: message.sender
                }
              };
            }

            // Sender display logic
            let senderDisplay;
            if (message.sender === "System" || message.sender === "Admin") {
              senderDisplay = `From ${senderObj.user.username}`;
            } else if (senderObj.nickname === senderObj.user.username) {
              senderDisplay = `
          <img src="/users/${senderObj.user.username}/pfp/" 
               alt="${senderObj.user.username}'s Profile Picture" 
               height="50px" width="70px" style="border:2px solid black; background-color: white !important;">
          <br>${senderObj.nickname}`;
            } else {
              senderDisplay = `
          <img src="/users/${senderObj.user.username}/pfp/" 
               alt="${senderObj.user.username}'s Profile Picture" 
               height="50px" width="70px" style="border:2px solid black; background-color: white !important;">
          <br>From @${senderObj.user.username} as "${senderObj.nickname}"`;
            }

            // Escape title always
            const safeTitle = escapeHTML(message.title);

            let safeContent;
            if (isSidebar) {
              // Sidebar rules
              if (message.sender === "System" || message.sender === "Admin") {
                safeContent = stripLinks(message.content); // strip <a>, keep text
              } else {
                safeContent = escapeHTML(message.content); // plain text only
              }
            } else {
              // Full page rules
              if (message.sender === "System" || message.sender === "Admin") {
                // allow links, but escape everything else
                const div = document.createElement("div");
                div.innerHTML = message.content;
                // escape non-link text
                div.childNodes.forEach(node => {
                  if (node.nodeType === Node.TEXT_NODE) {
                    node.textContent = escapeHTML(node.textContent);
                  }
                });
                safeContent = div.innerHTML;
              } else {
                safeContent = escapeHTML(message.content); // plain text only
              }
            }

            // Build message element
            const messageElement = document.createElement("li");
            messageElement.dataset.messageId = message.id;
            messageElement.className = message.isRead ? "read" : "unread";
            messageElement.innerHTML = `
        <h2>${safeTitle}</h2>
        <h3>${senderDisplay}:</h3>
        <p>${new Amp().Stickerify(safeContent)}</p>
        <div>
          ${(message.sender !== "System" && message.sender !== "Admin") ? `
            <button class="special-button">Report Message</button>
            ${(senderObj.user.username !== "<%= user.username %>") ? '<button class="special-button">Block user</button>' : ""}
          ` : ""}
          <button class="special-button" onclick="deleteMessage(${message.id})">Delete</button>
        </div>
      `;



            messagesBox.appendChild(messageElement);
          });
        })
        .catch(error => {
          console.error('Error loading messages:', error);
          showError();
        });
    }

    async function sendMessage() {
      const payload = {
        to: document.getElementById("message-to").value,
        text: document.getElementById("your-text").value,
        fromNickname: document.getElementById("Sender-Nickname").value,
        title: document.getElementById("message-title").value
      };

      fetch("/api/send/message", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      }).then(response => {
        console.log(response);
        return response.text();
      }).then(data => {
        console.log(data);
        window.clearTimeout(0);
        document.getElementById("server-response").textContent = data;
        window.setTimeout(function() {
          document.getElementById("server-response").textContent = "";
        }, 5000);
      });
    }

    async function refreshMessages() {
      window.document.getElementById("messages").innerHTML = "";
      window.document.getElementById("sent-messages").innerHTML = "";
      messageIndex = 0;
      messageSentIndex = 0;
      loadMessages();
      loadSentMessages();
    }

    window.document.getElementById("message-form").addEventListener("submit", function(event) {
      event.preventDefault();
    });

    loadMessages();
    loadSentMessages();
  </script>
  <script src="/JS/@.js"></script>
</body>

</html>